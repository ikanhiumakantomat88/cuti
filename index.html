<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- Wajib agar responsive di HP -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Sistem Cuti Pegawai</title>
    
    <!-- Library CSS & JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* --- KUSTOMISASI KALENDER DARK MODE --- */
        :root {
            --fc-border-color: #4b5563; /* Gray-600 borders */
            --fc-page-bg-color: #1f2937; /* Gray-800 background */
            --fc-neutral-bg-color: #374151; /* Gray-700 header bg */
            --fc-list-event-hover-bg-color: #4b5563;
            --fc-today-bg-color: rgba(59, 130, 246, 0.15) !important; /* Blue tint for today */
        }

        /* Text colors in calendar */
        .fc, .fc-col-header-cell-cushion, .fc-daygrid-day-number {
            color: #f3f4f6 !important; /* Light text */
            text-decoration: none !important;
        }

        /* Header cells background */
        .fc-col-header-cell {
            background-color: #374151;
            padding: 8px 0;
        }

        /* Event styles */
        .fc-event {
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Merahkan hari Minggu (Sunday) DAN Libur Nasional */
        .fc-day-sun, .fc-day-holiday {
            background-color: rgba(127, 29, 29, 0.3) !important; /* Red-900 tint */
        }

        /* CSS Tambahan agar kalender di HP font-nya tidak terlalu besar */
        @media (max-width: 640px) {
            .fc-toolbar-title { font-size: 1.2rem !important; }
            .fc-button { padding: 0.2rem 0.5rem !important; font-size: 0.8rem !important; }
        }
        
        /* Animasi Badge Notifikasi */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .animate-pulse-badge {
            animation: pulse-red 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-gray-100 font-sans selection:bg-blue-500 selection:text-white">

    <!-- KONFIGURASI API -->
    <script>
        // PENTING: Ganti URL di bawah ini dengan URL Web App Google Script Anda
        const API_URL = "https://script.google.com/macros/s/AKfycbxm6No8lbev3JjLgWgaEEcE_FPM6vUXH8VE4ZxVlJK8cDrjdTLCCF4afeX6feeiOZOeTw/exec"; 
    </script>

    <!-- LOADING OVERLAY (Modern Percentage) -->
    <div id="loading" class="hidden fixed inset-0 bg-gray-900/90 z-50 flex flex-col items-center justify-center backdrop-blur-sm transition-all duration-300">
        <div class="w-72 bg-gray-800/80 p-6 rounded-2xl border border-gray-700 shadow-2xl">
            <div class="flex justify-between mb-2 items-end">
                <span class="text-sm font-semibold text-blue-400 uppercase tracking-wider">Memproses</span>
                <span id="loading-percent" class="text-2xl font-bold text-white font-mono">0%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden shadow-inner border border-gray-600">
                <div id="loading-bar" class="bg-gradient-to-r from-blue-600 via-cyan-500 to-blue-400 h-full rounded-full transition-all duration-300 ease-out shadow-[0_0_10px_rgba(59,130,246,0.5)]" style="width: 0%"></div>
            </div>
            <p class="text-xs text-gray-500 mt-3 text-center italic animate-pulse">Mohon tunggu sebentar...</p>
        </div>
    </div>

    <!-- MODAL EDIT ANNOUNCEMENT (Manager Only) -->
    <div id="announcement-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-gray-800 w-full max-w-lg p-6 rounded-xl shadow-2xl border border-gray-700">
            <h3 class="text-xl font-bold text-white mb-4">Edit Pengumuman</h3>
            <textarea id="announcement-input" rows="4" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none transition placeholder-gray-500" placeholder="Tulis pengumuman di sini..."></textarea>
            <div class="flex justify-end gap-3 mt-4">
                <button onclick="document.getElementById('announcement-modal').classList.add('hidden')" class="px-4 py-2 rounded-lg text-gray-300 hover:text-white hover:bg-gray-700 transition">Batal</button>
                <button onclick="saveAnnouncement()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg shadow-yellow-600/20 transition">Simpan</button>
            </div>
        </div>
    </div>

    <!-- MODAL PROSES PENGAJUAN (BARU - LEBIH RAPI) -->
    <div id="process-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-gray-800 w-full max-w-md p-6 rounded-xl shadow-2xl border border-gray-700 transform transition-all scale-100">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center border-b border-gray-700 pb-3">
                <svg class="w-6 h-6 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Tinjau Pengajuan
            </h3>
            
            <div class="space-y-4 mb-6">
                <!-- Info Pegawai -->
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-400 uppercase tracking-wide">Pegawai</p>
                        <p id="modal-name" class="font-bold text-white text-lg">-</p>
                        <p id="modal-div" class="text-xs text-blue-300">-</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-400 uppercase tracking-wide">Tipe Cuti</p>
                        <span id="modal-type" class="inline-block mt-1 px-2 py-1 rounded bg-blue-500/20 text-blue-300 text-xs font-bold border border-blue-500/30">-</span>
                    </div>
                </div>
                
                <!-- Detail Tanggal -->
                <div class="bg-gray-700/30 p-3 rounded-lg border border-gray-600/50">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-gray-400 uppercase">Periode</span>
                        <span id="modal-days" class="text-xs font-bold text-yellow-400">- Hari</span>
                    </div>
                    <p id="modal-date" class="font-medium text-white text-sm">-</p>
                </div>

                <!-- Alasan -->
                <div>
                    <p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Alasan</p>
                    <div class="bg-gray-700/30 p-3 rounded-lg border border-gray-600/50">
                        <p id="modal-reason" class="text-sm text-gray-200 italic">"-"</p>
                    </div>
                </div>

                <!-- Input Catatan Admin -->
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Catatan Manager / Alasan Penolakan</label>
                    <textarea id="modal-admin-reason" rows="2" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition placeholder-gray-500 text-sm" placeholder="Tulis catatan (wajib jika menolak)..."></textarea>
                </div>
            </div>

            <!-- Tombol Aksi -->
            <div class="flex gap-3">
                <button onclick="processRequestAction('Rejected')" class="flex-1 bg-red-500/10 hover:bg-red-600 text-red-400 hover:text-white border border-red-500/50 py-2.5 rounded-lg font-bold transition flex items-center justify-center group">
                    <svg class="w-4 h-4 mr-2 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    Tolak
                </button>
                <button onclick="processRequestAction('Approved')" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2.5 rounded-lg font-bold shadow-lg shadow-green-600/20 transition flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    Terima
                </button>
            </div>
            <button onclick="closeProcessModal()" class="w-full mt-4 text-xs text-gray-500 hover:text-gray-300 underline text-center">Batal / Kembali</button>
        </div>
    </div>

    <!-- HALAMAN LOGIN -->
    <div id="login-view" class="flex items-center justify-center min-h-screen px-4 bg-gradient-to-br from-gray-900 to-gray-800">
        <div class="w-full max-w-md bg-gray-800 p-6 md:p-8 rounded-2xl shadow-2xl border border-gray-700">
            <div class="flex justify-center mb-6">
                <div class="bg-blue-600 p-3 rounded-full shadow-lg shadow-blue-500/30">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
            </div>
            <h2 class="text-2xl font-bold mb-6 text-center text-white tracking-wide">Portal Cuti</h2>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Username</label>
                    <input id="user-input" type="text" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-500" placeholder="Masukkan username">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Password</label>
                    <input id="pass-input" type="password" onkeydown="checkEnter(event)" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-500" placeholder="••••••••">
                </div>
                <button onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-blue-600/30 transform hover:scale-[1.02] active:scale-[0.98]">
                    Masuk
                </button>
            </div>
            <p class="text-xs text-center text-gray-500 mt-8 border-t border-gray-700 pt-4">&copy; Sistem Manajemen Cuti 2026</p>
        </div>
    </div>

    <!-- DASHBOARD UTAMA -->
    <div id="app-view" class="hidden max-w-7xl mx-auto p-3 md:p-6">
        
        <!-- SECTION PENGUMUMAN (Baru) -->
        <div id="announcement-section" class="mb-4 hidden">
            <div class="bg-yellow-500/10 border border-yellow-500/30 p-4 rounded-xl flex items-start md:items-center justify-between gap-4 shadow-lg">
                <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-yellow-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                    <div>
                        <h4 class="text-yellow-400 font-bold text-sm uppercase tracking-wide mb-1">Pengumuman</h4>
                        <p id="announcement-text" class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap">Loading...</p>
                    </div>
                </div>
                <!-- Tombol Edit hanya untuk Manager -->
                <button id="btn-edit-announcement" onclick="openAnnouncementModal()" class="hidden text-gray-400 hover:text-yellow-400 transition p-2 hover:bg-gray-700 rounded-lg" title="Edit Pengumuman">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                </button>
            </div>
        </div>

        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 border-l-4 border-l-blue-500 gap-4">
            <div class="w-full md:w-auto">
                <h1 class="text-lg md:text-xl font-bold text-white tracking-tight">Dashboard Cuti</h1>
                <p id="welcome-msg" class="text-xs md:text-sm text-gray-400 mt-0.5">Selamat datang</p>
            </div>
            
            <!-- JAM DIGITAL (UTC+7) -->
            <div id="clock-display" class="text-sm font-medium text-blue-300 bg-gray-900/50 px-4 py-2 rounded-lg border border-gray-600 shadow-inner w-full md:w-auto text-center tracking-wide">
                --:--:-- WIB
            </div>

            <div class="flex items-center gap-3 w-full md:w-auto justify-end">
                
                <!-- NOTIFIKASI BELL (Hanya Manager) -->
                <div id="manager-notif" class="hidden relative mr-2 cursor-pointer group" onclick="scrollToPending()">
                    <svg class="w-6 h-6 text-gray-400 group-hover:text-white transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    
                    <!-- Badge Notification -->
                    <span id="notif-badge" class="hidden absolute -top-1.5 -right-1.5 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border border-gray-800 min-w-[18px] text-center animate-pulse-badge">0</span>
                </div>

                <!-- Tombol Report (Hanya Manager) -->
                <button id="btn-report" onclick="toggleReportView()" class="hidden flex-1 md:flex-none bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-semibold transition items-center justify-center">
                    <svg class="w-4 h-4 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span class="hidden md:inline">Laporan</span>
                </button>
                <button onclick="logout()" class="flex-1 md:flex-none bg-red-500/10 text-red-400 border border-red-500/20 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-500 hover:text-white transition">
                    Logout
                </button>
            </div>
        </header>

        <!-- VIEW: DASHBOARD (Default) -->
        <div id="dashboard-content" class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- SIDEBAR (Menu) -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- STATUS WORKFORCE (Status Hari Ini) -->
                <div id="status-panel" class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                    <h3 class="font-bold text-white border-b border-gray-700 pb-3 mb-4 flex items-center text-lg">
                        <svg class="w-5 h-5 mr-2 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        Status Hari Ini
                    </h3>
                    <div id="status-content" class="text-sm">
                        <!-- Highlighted Box -->
                        <div class="bg-gray-700/30 border border-gray-600 rounded-lg p-4 text-center mb-3">
                             <div class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Sedang Cuti</div>
                             <div id="count-leave" class="text-5xl font-extrabold text-red-500 drop-shadow-sm">0</div>
                        </div>
                        
                        <div id="leave-names" class="text-xs text-gray-400 mt-3 space-y-1 max-h-[150px] overflow-y-auto px-1">
                            <p class="italic text-center opacity-50">- Tidak ada yang cuti -</p>
                        </div>
                    </div>
                </div>

                <!-- Panel Karyawan -->
                <div id="employee-controls" class="hidden space-y-6">
                    <!-- Form Pengajuan -->
                    <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                        <h3 class="font-bold text-white border-b border-gray-700 pb-3 mb-4 flex items-center text-lg">
                            <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Ajukan Cuti
                        </h3>
                        <div class="space-y-4">
                            <!-- NEW: Leave Type Selector -->
                            <div>
                                <label class="text-xs font-semibold text-gray-400 uppercase">Tipe Cuti</label>
                                <select id="leave-type" class="w-full mt-1 bg-gray-700 border border-gray-600 text-white p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                                    <option value="Tahunan">Cuti Tahunan (Yearly)</option>
                                    <option value="Bulanan">Cuti Bulanan (Monthly)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-400 uppercase">Mulai Tanggal</label>
                                <input id="start-date" type="date" onchange="updateDurationDisplay()" class="w-full mt-1 bg-gray-700 border border-gray-600 text-white p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition [color-scheme:dark]">
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-400 uppercase">Sampai Tanggal</label>
                                <input id="end-date" type="date" onchange="updateDurationDisplay()" class="w-full mt-1 bg-gray-700 border border-gray-600 text-white p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition [color-scheme:dark]">
                            </div>
                            
                            <!-- NEW: Duration Calculation Display -->
                            <div id="duration-box" class="hidden bg-blue-500/10 border border-blue-500/30 rounded-lg p-3">
                                <p class="text-xs text-blue-300">Total Hari (Termasuk Weekend/Libur):</p>
                                <p id="duration-text" class="text-lg font-bold text-white">0 Hari</p>
                            </div>

                            <div>
                                <label class="text-xs font-semibold text-gray-400 uppercase">Alasan</label>
                                <input id="reason" type="text" placeholder="Contoh: Acara Keluarga" class="w-full mt-1 bg-gray-700 border border-gray-600 text-white p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition placeholder-gray-500">
                            </div>
                            <button onclick="submitRequest()" class="w-full bg-green-600 hover:bg-green-500 text-white py-2.5 rounded-lg font-bold shadow-lg shadow-green-600/20 transition mt-2 transform active:scale-95">
                                Kirim Pengajuan
                            </button>
                        </div>
                    </div>

                    <!-- Riwayat Pengajuan (Notifikasi Status) -->
                    <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                        <h3 class="font-bold text-white border-b border-gray-700 pb-3 mb-4 flex items-center text-lg">
                            <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Riwayat Saya
                        </h3>
                        <div id="my-history-list" class="space-y-3 max-h-[300px] overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-transparent">
                            <!-- List akan muncul di sini -->
                            <p class="text-xs text-gray-500 italic text-center py-4">Belum ada riwayat.</p>
                        </div>
                    </div>
                </div>

                <!-- Panel Manager -->
                <div id="manager-controls" class="hidden bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                    <h3 class="font-bold text-white border-b border-gray-700 pb-3 mb-4 flex items-center text-lg">
                        <svg class="w-5 h-5 mr-2 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                        Menunggu Persetujuan
                    </h3>
                    <div id="pending-list" class="space-y-3 max-h-[500px] overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-transparent">
                        <!-- List akan muncul di sini -->
                        <p class="text-xs text-gray-500 italic text-center py-4">Tidak ada pengajuan pending.</p>
                    </div>
                </div>
            </div>

            <!-- AREA KALENDER -->
            <div class="lg:col-span-3 bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg border border-gray-700 min-h-[500px]">
                <div id="calendar" class="text-sm font-medium"></div>
            </div>
        </div>

        <!-- VIEW: REPORT (Manager Only) -->
        <div id="report-content" class="hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-gray-700 pb-4 gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-white">Laporan Rekapitulasi Cuti</h2>
                        <p class="text-xs text-gray-400 mt-1">Filter data per bulan/tahun untuk melihat sisa kuota.</p>
                    </div>
                    
                    <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                        <!-- FILTER BULAN -->
                        <select id="report-month" onchange="filterReport()" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            <option value="all">Semua Bulan (Tahunan)</option>
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Maret</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Agustus</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Desember</option>
                        </select>
                        
                        <!-- FILTER TAHUN -->
                        <select id="report-year" onchange="filterReport()" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                        </select>
                        
                        <button onclick="toggleReportView()" class="text-sm bg-gray-600 hover:bg-gray-500 text-white px-3 py-2 rounded-lg transition">
                            Kembali
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-gray-700 text-xs uppercase text-gray-200">
                            <tr>
                                <th class="px-4 py-3 rounded-tl-lg">Nama Pegawai</th>
                                <th class="px-4 py-3">Divisi</th>
                                <th class="px-4 py-3 text-center">Terpakai</th>
                                <th class="px-4 py-3 text-center">Kuota</th>
                                <th class="px-4 py-3 text-center">Sisa (Balance)</th>
                                <th class="px-4 py-3 text-center">Status Tips</th>
                                <th class="px-4 py-3 rounded-tr-lg text-right">Detail</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body" class="divide-y divide-gray-700">
                            <!-- Data injected via JS -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-xs text-gray-500 italic bg-gray-900/30 p-3 rounded border border-gray-700/50">
                    <span class="font-bold text-gray-300">Catatan Sistem:</span>
                    <ul class="list-disc ml-4 mt-1 space-y-1">
                        <li><strong>Filter Tahunan (Semua Bulan):</strong> Kuota cuti adalah 14 hari.</li>
                        <li><strong>Filter Bulanan:</strong> Kuota cuti adalah 2 hari.</li>
                        <li><strong>Balance:</strong> Dihitung berdasarkan total hari kalender (termasuk weekend & libur) yang jatuh pada periode yang dipilih.</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <script>
        let currentUser = null;
        let calendar = null;
        let allRequestsData = []; 
        let clockInterval = null; 
        let selectedRequestId = null; // ID Request yang sedang diproses di modal
        const SESSION_KEY = 'cuti_app_session'; 
        const SESSION_TIMEOUT = 12 * 60 * 60 * 1000; 

        // --- NEW HELPER: FORMAT DATE STRING (FIX FOR UTC ISSUE) ---
        function formatDateString(isoString) {
            if (!isoString) return "";
            // Parse the ISO string (which might be treated as UTC by new Date)
            const date = new Date(isoString);
            // Force the output to be in Jakarta timezone (WIB) with YYYY-MM-DD format
            // 'en-CA' outputs YYYY-MM-DD
            return date.toLocaleDateString('en-CA', { timeZone: 'Asia/Jakarta' });
        }

        // --- DATABASE LIBUR INDONESIA (2025-2028) ---
        const INDONESIAN_HOLIDAYS = {
            // 2026
            "2026-01-01": "Tahun Baru Masehi",
            "2026-01-16": "Isra Mikraj Nabi Muhammad SAW",
            "2026-02-17": "Tahun Baru Imlek 2577 Kongzili",
            "2026-03-19": "Hari Suci Nyepi Tahun Baru Saka 1948",
            "2026-03-21": "Idul Fitri 1447 H (Estimasi)",
            "2026-03-22": "Idul Fitri 1447 H (Estimasi)",
            "2026-04-03": "Wafat Yesus Kristus",
            "2026-04-05": "Paskah (Kebangkitan Yesus Kristus)",
            "2026-05-01": "Hari Buruh Internasional",
            "2026-05-14": "Kenaikan Yesus Kristus",
            "2026-05-27": "Idul Adha 1447 H (Estimasi)",
            "2026-05-31": "Hari Raya Waisak 2570 BE",
            "2026-06-01": "Hari Lahir Pancasila",
            "2026-06-16": "Tahun Baru Islam 1448 H",
            "2026-08-17": "Hari Kemerdekaan RI",
            "2026-08-25": "Maulid Nabi Muhammad SAW",
            "2026-12-25": "Hari Raya Natal",

            // 2027 (Estimasi)
            "2027-01-01": "Tahun Baru Masehi",
            "2027-01-05": "Isra Mikraj Nabi Muhammad SAW (Estimasi)",
            "2027-02-06": "Tahun Baru Imlek 2578 Kongzili",
            "2027-03-09": "Hari Suci Nyepi Tahun Baru Saka 1949",
            "2027-03-10": "Idul Fitri 1448 H (Estimasi)",
            "2027-03-11": "Idul Fitri 1448 H (Estimasi)",
            "2027-03-26": "Wafat Yesus Kristus",
            "2027-03-28": "Paskah",
            "2027-05-01": "Hari Buruh Internasional",
            "2027-05-06": "Kenaikan Yesus Kristus",
            "2027-05-17": "Idul Adha 1448 H (Estimasi)",
            "2027-05-20": "Hari Raya Waisak 2571 BE",
            "2027-06-01": "Hari Lahir Pancasila",
            "2027-06-06": "Tahun Baru Islam 1449 H",
            "2027-08-15": "Maulid Nabi Muhammad SAW (Estimasi)",
            "2027-08-17": "Hari Kemerdekaan RI",
            "2027-12-25": "Hari Raya Natal",
            "2027-12-26": "Isra Mikraj Nabi Muhammad SAW (Estimasi)",

            // 2028 (Estimasi)
            "2028-01-01": "Tahun Baru Masehi",
            "2028-01-26": "Tahun Baru Imlek 2579 Kongzili",
            "2028-02-26": "Idul Fitri 1449 H (Estimasi)",
            "2028-02-27": "Idul Fitri 1449 H (Estimasi)",
            "2028-03-26": "Hari Suci Nyepi Tahun Baru Saka 1950",
            "2028-04-14": "Wafat Yesus Kristus",
            "2028-04-16": "Paskah",
            "2028-05-01": "Hari Buruh Internasional",
            "2028-05-05": "Idul Adha 1449 H (Estimasi)",
            "2028-05-09": "Hari Raya Waisak 2572 BE",
            "2028-05-25": "Kenaikan Yesus Kristus & Tahun Baru Islam 1450 H",
            "2028-06-01": "Hari Lahir Pancasila",
            "2028-08-03": "Maulid Nabi Muhammad SAW (Estimasi)",
            "2028-08-17": "Hari Kemerdekaan RI",
            "2028-12-14": "Isra Mikraj Nabi Muhammad SAW (Estimasi)",
            "2028-12-25": "Hari Raya Natal"
        };

        // --- CEK SESI SAAT HALAMAN DIMUAT ---
        document.addEventListener("DOMContentLoaded", () => {
            checkSession();
            // Set default year selector to current year
            document.getElementById('report-year').value = new Date().getFullYear();
        });

        function checkSession() {
            const savedSession = localStorage.getItem(SESSION_KEY);
            if (savedSession) {
                try {
                    const decoded = atob(savedSession);
                    const sessionData = JSON.parse(decoded);

                    if (Date.now() > sessionData.expiry) {
                        console.warn("Sesi telah berakhir.");
                        localStorage.removeItem(SESSION_KEY);
                        return;
                    }
                    initializeDashboard(sessionData.user);
                } catch (e) {
                    console.error("Sesi tidak valid", e);
                    localStorage.removeItem(SESSION_KEY);
                }
            }
        }

        // --- FUNGSI UTILITY ---
        function checkEnter(event) {
            if (event.key === 'Enter') {
                handleLogin();
            }
        }

        // --- ADVANCED FEATURE: SMART CALCULATOR ---
        function calculateWorkingDays(startStr, endStr) {
            let count = 0;
            let currentDate = new Date(startStr);
            const stopDate = new Date(endStr);
            
            if (currentDate > stopDate) return 0;

            while (currentDate <= stopDate) {
                // MODIFIED: No longer skipping weekend/holiday
                // Just count everything.
                count++;
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return count;
        }

        // --- NEW: Calculate Working Days INSIDE a specific Period (Month/Year) ---
        function calculateWorkingDaysInPeriod(reqStartStr, reqEndStr, periodStart, periodEnd) {
            // Konversi ke object Date
            const rStart = new Date(reqStartStr);
            const rEnd = new Date(reqEndStr);
            
            // Cari irisan tanggal (Overlap)
            // Start adalah yang paling akhir antara Request Start dan Period Start
            const start = rStart > periodStart ? rStart : periodStart;
            // End adalah yang paling awal antara Request End dan Period End
            const end = rEnd < periodEnd ? rEnd : periodEnd;
            
            // Jika tidak ada overlap (start > end), kembalikan 0
            if (start > end) return 0;
            
            // Hitung hari kerja dalam periode overlap
            // Use local date strings to prevent offset issues
            const sStr = start.toLocaleDateString('en-CA', {timeZone: 'Asia/Jakarta'});
            const eStr = end.toLocaleDateString('en-CA', {timeZone: 'Asia/Jakarta'});
            return calculateWorkingDays(sStr, eStr);
        }

        function updateDurationDisplay() {
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            const box = document.getElementById('duration-box');
            const text = document.getElementById('duration-text');

            if (start && end) {
                const totalDays = calculateWorkingDays(start, end);
                
                text.innerText = `${totalDays} Hari`;
                box.classList.remove('hidden');
            } else {
                box.classList.add('hidden');
            }
        }

        function calculateSimpleDays(startStr, endStr) {
            const start = new Date(startStr);
            const end = new Date(endStr);
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
        }

        function toggleReportView() {
            const dash = document.getElementById('dashboard-content');
            const report = document.getElementById('report-content');
            const btn = document.getElementById('btn-report');
            const ann = document.getElementById('announcement-section');
            
            if (dash.classList.contains('hidden')) {
                dash.classList.remove('hidden');
                ann.classList.remove('hidden'); 
                report.classList.add('hidden');
                btn.classList.remove('bg-gray-600');
                btn.classList.add('bg-blue-600');
                btn.innerHTML = `<svg class="w-4 h-4 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span class="hidden md:inline">Laporan</span>`;
            } else {
                dash.classList.add('hidden');
                ann.classList.add('hidden'); 
                report.classList.remove('hidden');
                // Trigger filter when opening report
                filterReport();
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-600');
                btn.innerHTML = `← Kembali`;
            }
        }

        // --- NEW: Filter Function ---
        function filterReport() {
            const monthVal = document.getElementById('report-month').value;
            const yearVal = document.getElementById('report-year').value;
            
            renderReportTable(allRequestsData, monthVal, yearVal);
        }

        function scrollToPending() {
            const pendingList = document.getElementById('manager-controls');
            if(pendingList && !pendingList.classList.contains('hidden')) {
                pendingList.scrollIntoView({ behavior: 'smooth' });
                pendingList.classList.add('ring-2', 'ring-yellow-500');
                setTimeout(() => pendingList.classList.remove('ring-2', 'ring-yellow-500'), 2000);
            }
        }

        function startClock() {
            if (clockInterval) clearInterval(clockInterval);
            const update = () => {
                const el = document.getElementById('clock-display');
                if (!el) return;
                const now = new Date();
                const options = { 
                    timeZone: 'Asia/Jakarta', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false 
                };
                let timeString = new Intl.DateTimeFormat('id-ID', options).format(now);
                timeString = timeString.replace(/\./g, ':');
                el.innerText = timeString + " WIB";
            };
            update(); 
            clockInterval = setInterval(update, 1000); 
        }

        // --- LOADING ANIMATION CONTROLLER ---
        let loadingInterval;
        
        function showLoading() {
            const el = document.getElementById('loading');
            const bar = document.getElementById('loading-bar');
            const txt = document.getElementById('loading-percent');
            
            el.classList.remove('hidden');
            let progress = 0;
            
            // Reset state
            bar.style.width = '0%';
            txt.innerText = '0%';
            
            if(loadingInterval) clearInterval(loadingInterval);
            
            loadingInterval = setInterval(() => {
                // Simulate progress curve: Fast at start, slows down near 90%
                if (progress < 60) {
                    progress += Math.random() * 4; 
                } else if (progress < 85) {
                    progress += Math.random() * 2;
                } else if (progress < 95) {
                    progress += 0.5;
                }
                
                // Cap at 95% until real response comes
                if (progress > 95) progress = 95;
                
                bar.style.width = `${progress}%`;
                txt.innerText = `${Math.round(progress)}%`;
            }, 200);
        }

        function hideLoading() {
            if(loadingInterval) clearInterval(loadingInterval);
            
            const el = document.getElementById('loading');
            const bar = document.getElementById('loading-bar');
            const txt = document.getElementById('loading-percent');
            
            // Complete the animation
            bar.style.width = '100%';
            txt.innerText = '100%';
            
            // Hide after short delay
            setTimeout(() => {
                el.classList.add('hidden');
            }, 500);
        }

        async function callAPI(payload) {
            if(!API_URL.includes("script.google.com")) {
                alert("ERROR: Anda belum memasukkan URL Google Script di kode HTML baris 15!");
                return;
            }
            
            showLoading(); // Start animation
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                hideLoading(); // Finish animation
                return result;
            } catch (error) {
                hideLoading(); // Finish even on error so UI doesn't hang
                alert("Gagal terhubung ke server. Cek koneksi internet.");
                console.error(error);
                return null;
            }
        }

        // --- LOGIKA APLIKASI ---
        async function handleLogin() {
            const u = document.getElementById('user-input').value.trim();
            const p = document.getElementById('pass-input').value.trim();
            if(!u || !p) return alert("Username dan Password wajib diisi");

            const res = await callAPI({ action: 'login', username: u, password: p });

            if (res && res.success) {
                const sessionData = { user: res, expiry: Date.now() + SESSION_TIMEOUT };
                const encoded = btoa(JSON.stringify(sessionData));
                localStorage.setItem(SESSION_KEY, encoded);
                document.getElementById('pass-input').value = "";
                initializeDashboard(res);
            } else {
                alert("Login Gagal: Username atau Password salah.");
                document.getElementById('pass-input').value = ""; 
            }
        }

        function initializeDashboard(user) {
            currentUser = user;
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            
            const displayName = user.realName || user.username;
            const displayRole = user.role + (user.division ? ` - ${user.division}` : '');
            document.getElementById('welcome-msg').innerText = `Halo, ${displayName} (${displayRole})`;

            startClock();
            document.getElementById('manager-controls').classList.add('hidden');
            document.getElementById('employee-controls').classList.add('hidden');
            document.getElementById('btn-report').classList.add('hidden'); 
            document.getElementById('btn-edit-announcement').classList.add('hidden');
            document.getElementById('manager-notif').classList.add('hidden');

            if (user.role === 'Manager') {
                document.getElementById('manager-controls').classList.remove('hidden');
                document.getElementById('btn-report').classList.remove('hidden'); 
                document.getElementById('btn-edit-announcement').classList.remove('hidden'); 
                document.getElementById('manager-notif').classList.remove('hidden'); 
            } else {
                document.getElementById('employee-controls').classList.remove('hidden');
            }
            loadData();
            loadAnnouncement();
        }

        function logout() {
            if(confirm("Keluar dari aplikasi?")) {
                localStorage.removeItem(SESSION_KEY);
                currentUser = null;
                if(clockInterval) clearInterval(clockInterval);
                document.getElementById('app-view').classList.add('hidden');
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('user-input').value = "";
                document.getElementById('pass-input').value = "";
                document.getElementById('welcome-msg').innerText = "";
                document.getElementById('manager-controls').classList.add('hidden');
                document.getElementById('employee-controls').classList.add('hidden');
                const dash = document.getElementById('dashboard-content');
                const report = document.getElementById('report-content');
                dash.classList.remove('hidden');
                report.classList.add('hidden');
            }
        }

        async function loadAnnouncement() {
            const res = await callAPI({ action: 'getAnnouncement' });
            const annSection = document.getElementById('announcement-section');
            const annText = document.getElementById('announcement-text');
            if (res && res.success && res.text) {
                annText.innerText = res.text;
                annSection.classList.remove('hidden');
            } else {
                if(currentUser.role === 'Manager') {
                    annText.innerText = "Belum ada pengumuman aktif. Klik tombol pensil untuk mengedit.";
                    annSection.classList.remove('hidden');
                } else {
                    annSection.classList.add('hidden');
                }
            }
        }

        function openAnnouncementModal() {
            const currentText = document.getElementById('announcement-text').innerText;
            document.getElementById('announcement-input').value = currentText === "Belum ada pengumuman aktif. Klik tombol pensil untuk mengedit." ? "" : currentText;
            document.getElementById('announcement-modal').classList.remove('hidden');
        }

        async function saveAnnouncement() {
            const newText = document.getElementById('announcement-input').value;
            const res = await callAPI({ 
                action: 'updateAnnouncement', 
                text: newText,
                username: currentUser.username
            });
            if(res && res.success) {
                document.getElementById('announcement-modal').classList.add('hidden');
                loadAnnouncement(); 
            } else {
                alert("Gagal menyimpan pengumuman.");
            }
        }

        function updateNotificationCount(data) {
            if (currentUser.role !== 'Manager') return;
            const pendingCount = data.filter(r => r.status === 'Pending').length;
            const badge = document.getElementById('notif-badge');
            if (pendingCount > 0) {
                badge.innerText = pendingCount;
                badge.classList.remove('hidden');
                document.title = `(${pendingCount}) Sistem Cuti Pegawai`;
            } else {
                badge.classList.add('hidden');
                document.title = `Sistem Cuti Pegawai`;
            }
        }

        async function submitRequest() {
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            const type = document.getElementById('leave-type').value; // Ambil Tipe Cuti
            const rawReason = document.getElementById('reason').value;

            if(!start || !end) return alert("Harap isi tanggal mulai dan selesai.");

            const formattedReason = `[${type}] ${rawReason}`;

            const res = await callAPI({
                action: 'addRequest',
                username: currentUser.username,
                division: currentUser.division, 
                start: start, end: end, 
                reason: formattedReason 
            });

            if(res && res.success) {
                alert("Pengajuan Cuti Berhasil Dikirim!");
                document.getElementById('start-date').value = "";
                document.getElementById('end-date').value = "";
                document.getElementById('reason').value = "";
                document.getElementById('duration-box').classList.add('hidden');
                loadData();
            }
        }

        // --- NEW MODAL LOGIC FOR APPROVAL ---
        
        function openProcessModal(id) {
            const req = allRequestsData.find(r => r.id == id);
            if (!req) return;

            selectedRequestId = id; // Simpan ID untuk diproses nanti

            // Extract Type & Reason
            const typeMatch = req.reason.match(/^\[(.*?)\]/);
            const type = typeMatch ? typeMatch[1] : 'Umum';
            const cleanReason = req.reason.replace(/^\[.*?\]\s*/, '');
            
            // Fix Date Strings using new helper
            const startDateStr = formatDateString(req.start);
            const endDateStr = formatDateString(req.end);

            // Calculate Days
            const days = calculateWorkingDays(startDateStr, endDateStr);

            // Populate Modal
            document.getElementById('modal-name').innerText = req.realName || req.username;
            document.getElementById('modal-div').innerText = req.division || '-';
            document.getElementById('modal-type').innerText = type;
            document.getElementById('modal-days').innerText = `${days} Hari`;
            document.getElementById('modal-date').innerText = `${startDateStr} s/d ${endDateStr}`;
            document.getElementById('modal-reason').innerText = `"${cleanReason}"`;
            
            // Reset input
            document.getElementById('modal-admin-reason').value = "";

            // Show Modal
            document.getElementById('process-modal').classList.remove('hidden');
        }

        function closeProcessModal() {
            document.getElementById('process-modal').classList.add('hidden');
            selectedRequestId = null;
        }

        async function processRequestAction(status) {
            if (!selectedRequestId) return;

            const adminReason = document.getElementById('modal-admin-reason').value.trim();

            // Validasi: Jika Reject, wajib ada alasan
            if (status === 'Rejected' && !adminReason) {
                alert("Wajib mengisi alasan penolakan!");
                return;
            }

            // Jika Approve tapi ada overflow quota
            if (status === 'Approved') {
                const req = allRequestsData.find(r => r.id == selectedRequestId);
                const limitCheck = checkLeaveLimit(formatDateString(req.start), formatDateString(req.end));
                if (limitCheck.overflow) {
                    const confirmOverflow = confirm(
                        `PERINGATAN: Tanggal ${limitCheck.date} sudah ada ${limitCheck.count} pegawai yang cuti.\n\n` +
                        `Lanjutkan approval?`
                    );
                    if (!confirmOverflow) return; 
                }
            }

            // Call API
            const res = await callAPI({ 
                action: 'updateStatus', 
                id: selectedRequestId, 
                status: status, 
                adminReason: adminReason 
            });

            if (res && res.success) {
                closeProcessModal();
                loadData();
            } else {
                alert("Gagal memproses pengajuan.");
            }
        }

        async function loadData() {
            const res = await callAPI({ action: 'getRequests' });
            if (!res || !res.success) return;
            allRequestsData = res.data; 
            renderCalendar(res.data);
            renderManagerList(res.data);
            renderEmployeeHistory(res.data);
            renderTodayStatus(res.data); 
            updateNotificationCount(res.data); 
            
            // Check if report view is active, if so update it with defaults
            if (!document.getElementById('report-content').classList.contains('hidden')) {
                filterReport();
            }
        }

        function renderTodayStatus(data) {
            const today = new Date().toISOString().split('T')[0];
            const onLeaveToday = data.filter(r => {
                if (r.status !== 'Approved') return false;
                // Use helper to ensure we compare local Jakarta date
                const dates = getDatesInRange(formatDateString(r.start), formatDateString(r.end));
                return dates.includes(today);
            });

            const count = onLeaveToday.length;
            document.getElementById('count-leave').innerText = count;

            const nameListEl = document.getElementById('leave-names');
            if (count > 0) {
                const names = onLeaveToday.map(r => {
                    const displayName = r.realName || r.username;
                    const typeMatch = r.reason.match(/^\[(.*?)\]/);
                    const typeLabel = typeMatch ? `<span class="text-xs text-yellow-500 font-bold ml-1">${typeMatch[1]}</span>` : '';

                    return `<div class="mb-1 border-l-2 border-yellow-500 pl-2 ml-1">
                                <div class="font-bold text-gray-200">${displayName}</div>
                                <div class="text-[10px] text-gray-500">${r.division || '-'} ${typeLabel}</div>
                            </div>`;
                }).join('');
                nameListEl.innerHTML = names;
                nameListEl.classList.remove('italic');
            } else {
                nameListEl.innerHTML = "- Tidak ada yang cuti -";
                nameListEl.classList.add('italic');
            }
        }

        // --- UPDATED REPORT TABLE ---
        function renderReportTable(data, selectedMonth = 'all', selectedYear = new Date().getFullYear()) {
            const tbody = document.getElementById('report-table-body');
            tbody.innerHTML = "";
            const userStats = {};

            // 1. Tentukan Periode Filter
            let periodStart, periodEnd;
            let quota = 0;

            if (selectedMonth === 'all') {
                // Setahun Penuh
                periodStart = new Date(selectedYear, 0, 1);
                periodEnd = new Date(selectedYear, 11, 31);
                quota = 14; // Kuota Tahunan
            } else {
                // Bulan Tertentu
                const m = parseInt(selectedMonth);
                periodStart = new Date(selectedYear, m, 1);
                // Akhir bulan (tanggal 0 bulan berikutnya = tanggal terakhir bulan ini)
                periodEnd = new Date(selectedYear, m + 1, 0); 
                quota = 2; // Kuota Bulanan
            }

            data.forEach(r => {
                // Hanya hitung yang Approved
                if (r.status === 'Approved') {
                    const key = r.username;
                    if (!userStats[key]) {
                        userStats[key] = {
                            realName: r.realName || r.username,
                            division: r.division || '-',
                            usedDays: 0,
                            history: []
                        };
                    }
                    
                    // Hitung hari kerja HANYA yang jatuh di periode terpilih
                    // FIX: Use formatDateString to prevent UTC offset errors in calculation
                    const days = calculateWorkingDaysInPeriod(
                        formatDateString(r.start), 
                        formatDateString(r.end), 
                        periodStart, 
                        periodEnd
                    );

                    if (days > 0) {
                        userStats[key].usedDays += days;
                        // Parse Type
                        const typeMatch = r.reason.match(/^\[(.*?)\]/);
                        const type = typeMatch ? typeMatch[1] : 'Umum';
                        
                        // Tampilkan history jika relevan dengan periode ini
                        userStats[key].history.push(`<span class="text-xs bg-gray-700 px-1 rounded">${type}</span> ${formatDateString(r.start)} - ${formatDateString(r.end)} (${days}hr di periode ini)`);
                    }
                }
            });

            // Render
            Object.values(userStats).forEach(stat => {
                const historyHtml = stat.history.map(h => `<div class="text-xs text-gray-500 mb-0.5">${h}</div>`).join('');
                
                // Hitung Balance
                const balance = quota - stat.usedDays;
                
                // Tentukan Status Tips
                let statusBadge = "";
                if (balance >= 0) {
                    statusBadge = `<span class="bg-green-900/40 text-green-400 border border-green-500/30 text-xs px-2 py-0.5 rounded font-bold">Eligible Tips ✅</span>`;
                } else {
                    statusBadge = `<span class="bg-red-900/40 text-red-400 border border-red-500/30 text-xs px-2 py-0.5 rounded font-bold">Over Limit ⚠️</span>`;
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-700/50 transition border-b border-gray-700/50">
                        <td class="px-4 py-3 font-medium text-white">${stat.realName}</td>
                        <td class="px-4 py-3 text-gray-400">${stat.division}</td>
                        <td class="px-4 py-3 text-center text-white">${stat.usedDays}</td>
                        <td class="px-4 py-3 text-center text-gray-400">${quota}</td>
                        <td class="px-4 py-3 text-center font-bold ${balance < 0 ? 'text-red-400' : 'text-blue-400'}">${balance}</td>
                        <td class="px-4 py-3 text-center">${statusBadge}</td>
                        <td class="px-4 py-3 text-right">
                            ${historyHtml}
                        </td>
                    </tr>
                `;
            });

            if (Object.keys(userStats).length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-gray-500 italic">Belum ada cuti yang disetujui pada periode ini.</td></tr>`;
            }
        }

        function getDatesInRange(startDateStr, endDateStr) {
            const dates = [];
            let currentDate = new Date(startDateStr);
            const stopDate = new Date(endDateStr);
            while (currentDate <= stopDate) {
                dates.push(new Date(currentDate).toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        function checkLeaveLimit(startDate, endDate) {
            const dateRange = getDatesInRange(startDate, endDate);
            const approvedRequests = allRequestsData.filter(r => r.status === 'Approved');
            for (let date of dateRange) {
                let count = 0;
                for (let req of approvedRequests) {
                    // Fix: Ensure comparison uses corrected dates
                    const reqRange = getDatesInRange(formatDateString(req.start), formatDateString(req.end));
                    if (reqRange.includes(date)) count++;
                }
                if (count >= 2) return { overflow: true, date: date, count: count };
            }
            return { overflow: false };
        }

        function renderCalendar(data) {
            const calendarEl = document.getElementById('calendar');
            const isMobile = window.innerWidth < 768;
            
            if(!calendar) {
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    height: 'auto', 
                    headerToolbar: {
                        left: isMobile ? 'prev,next' : 'prev,next today',
                        center: 'title',
                        right: isMobile ? '' : 'dayGridMonth,listWeek'
                    },
                    buttonText: { today: 'Hari Ini', month: 'Bulan', list: 'List' },
                    footerToolbar: isMobile ? { center: 'today' } : false,
                    dayCellClassNames: (arg) => {
                        const dateStr = arg.date.toLocaleDateString('en-CA');
                        if (INDONESIAN_HOLIDAYS[dateStr]) return ['fc-day-holiday'];
                        return [];
                    },
                    dayCellDidMount: (arg) => {
                        const dateStr = arg.date.toLocaleDateString('en-CA');
                        if (INDONESIAN_HOLIDAYS[dateStr]) arg.el.setAttribute('title', INDONESIAN_HOLIDAYS[dateStr]);
                    },
                    eventDidMount: function(info) {
                        if (info.event.extendedProps.description) {
                            info.el.setAttribute('title', "Alasan: " + info.event.extendedProps.description);
                        }
                    }
                });
                calendar.render();
            }
            
            const events = data
                .filter(r => r.status !== 'Rejected') 
                .map(r => {
                    let color = '#f59e0b'; 
                    let desc = r.reason;
                    
                    const typeMatch = r.reason.match(/^\[(.*?)\]/);
                    const type = typeMatch ? typeMatch[1] : 'Umum';
                    let displayTitle = r.realName || r.username;

                    if(r.status === 'Approved') {
                        if(type === 'Tahunan') color = '#10b981'; // Green for Annual
                        else if(type === 'Bulanan') color = '#3b82f6'; // Blue for Monthly
                        else color = '#6b7280'; // Gray for legacy/other
                        
                        displayTitle = `${displayTitle} (${type})`;
                    } else {
                        displayTitle = `${displayTitle} (Pending)`;
                    }

                    // Fix: Use helper to format date strings correctly
                    return {
                        title: displayTitle,
                        start: formatDateString(r.start),
                        end: formatDateString(r.end),
                        color: color,
                        allDay: true,
                        extendedProps: { description: desc }
                    };
                });
            
            calendar.removeAllEvents();
            calendar.addEventSource(events);
        }

        function renderManagerList(data) {
            if (currentUser.role !== 'Manager') return;
            const list = document.getElementById('pending-list');
            list.innerHTML = "";
            const pendingItems = data.filter(r => r.status === 'Pending');

            if(pendingItems.length === 0) {
                 list.innerHTML = '<p class="text-xs text-gray-500 italic text-center py-4">Tidak ada pengajuan pending.</p>';
                 return;
            }
            
            pendingItems.forEach(r => {
                const divisionBadge = r.division 
                    ? `<span class="ml-2 text-[10px] bg-blue-500/20 text-blue-300 px-1.5 py-0.5 rounded border border-blue-500/30 uppercase tracking-wide">${r.division}</span>` 
                    : '';
                const displayName = r.realName || r.username;
                
                const typeMatch = r.reason.match(/^\[(.*?)\]/);
                const typeLabel = typeMatch ? `<span class="ml-2 text-[10px] bg-gray-600 text-white px-1.5 py-0.5 rounded uppercase tracking-wide">${typeMatch[1]}</span>` : '';
                const cleanReason = r.reason.replace(/^\[.*?\]\s*/, ''); 

                // FIX: Use formatDateString here
                const sDate = formatDateString(r.start);
                const eDate = formatDateString(r.end);

                list.innerHTML += `
                    <div class="bg-gray-700/50 p-4 border border-gray-600 rounded-lg shadow-sm hover:bg-gray-700 transition">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center">
                                <span class="font-bold text-white text-lg">${displayName}</span>
                                ${divisionBadge} ${typeLabel}
                            </div>
                            <span class="text-xs bg-yellow-500/20 text-yellow-300 border border-yellow-500/30 px-2 py-0.5 rounded-full font-medium">Pending</span>
                        </div>
                        <p class="text-xs text-gray-400 mb-1 flex items-center">
                            📅 ${sDate} <span class="mx-1">➞</span> ${eDate}
                        </p>
                        <div class="text-sm text-gray-300 mb-4 bg-gray-800 p-2.5 rounded border border-gray-600 italic">
                            "${cleanReason}"
                        </div>
                        <div class="grid grid-cols-1">
                            <button onclick="openProcessModal(${r.id})" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-blue-900/20 flex items-center justify-center">
                                🔍 Tinjau Pengajuan
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        function renderEmployeeHistory(data) {
            if (currentUser.role === 'Manager') return;
            const list = document.getElementById('my-history-list');
            list.innerHTML = "";
            const myItems = data.filter(r => r.username.toLowerCase() === currentUser.username.toLowerCase());

            if(myItems.length === 0) {
                 list.innerHTML = '<p class="text-xs text-gray-500 italic text-center py-4">Belum ada riwayat pengajuan.</p>';
                 return;
            }

            myItems.forEach(r => {
                let badgeClass = "bg-yellow-500/20 text-yellow-300 border-yellow-500/30";
                if(r.status === 'Approved') badgeClass = "bg-green-500/20 text-green-300 border-green-500/30";
                
                let rejectNote = "";
                if(r.status === 'Rejected') {
                    badgeClass = "bg-red-500/20 text-red-300 border-red-500/30";
                    const reasonText = r.adminReason ? r.adminReason : "-";
                    rejectNote = `
                        <div class="mt-2 p-2 bg-red-900/30 border border-red-500/20 rounded text-xs text-red-200">
                            <span class="font-bold text-red-400">Alasan Ditolak:</span> ${reasonText}
                        </div>
                    `;
                }

                const typeMatch = r.reason.match(/^\[(.*?)\]/);
                const typeLabel = typeMatch ? `<span class="text-[10px] bg-gray-600 text-white px-1.5 py-0.5 rounded uppercase mr-2">${typeMatch[1]}</span>` : '';
                const cleanReason = r.reason.replace(/^\[.*?\]\s*/, '');

                // FIX: Use formatDateString
                const sDate = formatDateString(r.start);

                list.innerHTML += `
                    <div class="bg-gray-700/30 p-3 border border-gray-600 rounded-lg">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-400">${sDate}</span>
                            <span class="text-[10px] px-2 py-0.5 rounded-full border ${badgeClass} font-medium uppercase">${r.status}</span>
                        </div>
                        <div class="flex items-center mb-1 mt-1">
                            ${typeLabel}
                        </div>
                        <p class="text-sm font-semibold text-gray-200">"${cleanReason}"</p>
                        ${rejectNote}
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
