<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- Wajib agar responsive di HP -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Sistem Cuti Pegawai</title>
    
    <!-- Library CSS & JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* --- KUSTOMISASI KALENDER DARK MODE --- */
        :root {
            --fc-border-color: #4b5563; /* Gray-600 borders */
            --fc-page-bg-color: #1f2937; /* Gray-800 background */
            --fc-neutral-bg-color: #374151; /* Gray-700 header bg */
            --fc-list-event-hover-bg-color: #4b5563;
            --fc-today-bg-color: rgba(59, 130, 246, 0.15) !important; /* Blue tint for today */
        }

        /* Text colors in calendar */
        .fc, .fc-col-header-cell-cushion, .fc-daygrid-day-number {
            color: #f3f4f6 !important; /* Light text */
            text-decoration: none !important;
        }

        /* Header cells background */
        .fc-col-header-cell {
            background-color: #374151;
            padding: 8px 0;
        }

        /* Event styles */
        .fc-event {
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Merahkan hari Minggu (Sunday) DAN Libur Nasional */
        .fc-day-sun, .fc-day-holiday {
            background-color: rgba(127, 29, 29, 0.3) !important; /* Red-900 tint */
        }

        /* CSS Tambahan agar kalender di HP font-nya tidak terlalu besar */
        @media (max-width: 640px) {
            .fc-toolbar-title { font-size: 1.2rem !important; }
            .fc-button { padding: 0.2rem 0.5rem !important; font-size: 0.8rem !important; }
        }
        
        /* Animasi Badge Notifikasi */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .animate-pulse-badge {
            animation: pulse-red 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-gray-100 font-sans selection:bg-blue-500 selection:text-white">

    <!-- KONFIGURASI API -->
    <script>
        // PENTING: Ganti URL di bawah ini dengan URL Web App Google Script Anda
        const API_URL = "https://script.google.com/macros/s/AKfycbyCxeTagVpVAXP_m3m-tB1RlwJ18aIlKxZ_-MMHKCOaJt1EEXshU5E-ZaTex92N_kFjrQ/exec"; 
    </script>

    <!-- LOADING OVERLAY (Muncul saat proses data) -->
    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl flex flex-col items-center border border-gray-700">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mb-3"></div>
            <span class="text-sm font-semibold text-blue-400">Memproses Data...</span>
        </div>
    </div>

    <!-- MODAL EDIT ANNOUNCEMENT (Manager Only) -->
    <div id="announcement-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-gray-800 w-full max-w-lg p-6 rounded-xl shadow-2xl border border-gray-700">
            <h3 class="text-xl font-bold text-white mb-4">Edit Pengumuman</h3>
            <textarea id="announcement-input" rows="4" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none transition placeholder-gray-500" placeholder="Tulis pengumuman di sini..."></textarea>
            <div class="flex justify-end gap-3 mt-4">
                <button onclick="document.getElementById('announcement-modal').classList.add('hidden')" class="px-4 py-2 rounded-lg text-gray-300 hover:text-white hover:bg-gray-700 transition">Batal</button>
                <button onclick="saveAnnouncement()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg shadow-yellow-600/20 transition">Simpan</button>
            </div>
        </div>
    </div>

    <!-- HALAMAN LOGIN -->
    <div id="login-view" class="flex items-center justify-center min-h-screen px-4 bg-gradient-to-br from-gray-900 to-gray-800">
        <div class="w-full max-w-md bg-gray-800 p-6 md:p-8 rounded-2xl shadow-2xl border border-gray-700">
            <div class="flex justify-center mb-6">
                <div class="bg-blue-600 p-3 rounded-full shadow-lg shadow-blue-500/30">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
            </div>
            <h2 class="text-2xl font-bold mb-6 text-center text-white tracking-wide">Portal Cuti</h2>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Username</label>
                    <input id="user-input" type="text" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-500" placeholder="Masukkan username">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Password</label>
                    <input id="pass-input" type="password" onkeydown="checkEnter(event)" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-blue-600/30 transform hover:scale-[1.02] active:scale-[0.98]">
                    Masuk
                </button>
            </div>
            <p class="text-xs text-center text-gray-500 mt-8 border-t border-gray-700 pt-4">&copy; Sistem Manajemen Cuti 2026</p>
        </div>
    </div>

    <!-- DASHBOARD UTAMA -->
    <div id="app-view" class="hidden max-w-7xl mx-auto p-3 md:p-6">
        
        <!-- SECTION PENGUMUMAN (Baru) -->
        <div id="announcement-section" class="mb-4 hidden">
            <div class="bg-yellow-500/10 border border-yellow-500/30 p-4 rounded-xl flex items-start md:items-center justify-between gap-4 shadow-lg">
                <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-yellow-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                    <div>
                        <h4 class="text-yellow-400 font-bold text-sm uppercase tracking-wide mb-1">Pengumuman</h4>
                        <p id="announcement-text" class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap">Loading...</p>
                    </div>
                </div>
                <!-- Tombol Edit hanya untuk Manager -->
                <button id="btn-edit-announcement" onclick="openAnnouncementModal()" class="hidden text-gray-400 hover:text-yellow-400 transition p-2 hover:bg-gray-700 rounded-lg" title="Edit Pengumuman">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                </button>
            </div>
        </div>

        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 border-l-4 border-l-blue-500 gap-4">
            <div class="w-full md:w-auto">
                <h1 class="text-lg md:text-xl font-bold text-white tracking-tight">Dashboard Cuti</h1>
                <p id="welcome-msg" class="text-xs md:text-sm text-gray-400 mt-0.5">Selamat datang</p>
            </div>
            
            <!-- JAM DIGITAL (UTC+7) -->
            <div id="clock-display" class="text-sm font-medium text-blue-300 bg-gray-900/50 px-4 py-2 rounded-lg border border-gray-600 shadow-inner w-full md:w-auto text-center tracking-wide">
                --:--:-- WIB
            </div>

            <div class="flex items-center gap-3 w-full md:w-auto justify-end">
                
                <!-- NOTIFIKASI BELL (Hanya Manager) -->
                <div id="manager-notif" class="hidden relative mr-2 cursor-pointer group" onclick="scrollToPending()">
                    <svg class="w-6 h-6 text-gray-400 group-hover:text-white transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    
                    <!-- Badge Notification -->
                    <span id="notif-badge" class="hidden absolute -top-1.5 -right-1.5 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border border-gray-800 min-w-[18px] text-center animate-pulse-badge">0</span>
                </div>

                <!-- Tombol Report (Hanya Manager) -->
                <button id="btn-report" onclick="toggleReportView()" class="hidden flex-1 md:flex-none bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-semibold transition items-center justify-center">
                    <svg class="w-4 h-4 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span class="hidden md:inline">Laporan</span>
                </button>
                <button onclick="logout()" class="flex-1 md:flex-none bg-red-500/10 text-red-400 border border-red-500/20 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-500 hover:text-white transition">
                    Logout
                </button>
            </div>
        </header>

        <!-- VIEW: DASHBOARD (Default) -->
        <div id="dashboard-content" class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- SIDEBAR (Menu) -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- STATUS WORKFORCE (Status Hari Ini) -->
                <div id="status-panel" class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                    <h3 class="font-bold text-white border-b border-gray-700 pb-3 mb-4 flex items-center text-lg">
                        <svg class="w-5 h-5 mr-2 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        Status Hari Ini
                    </h3>
                    <div id="status-content" class="text-sm">
                        <!-- Highlighted Box -->
                        <div class="bg-gray-700/30 border border-gray-600 rounded-lg p-4 text-center mb-3">
                             <div class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Sedang Cuti</div>
                             <div id="count-leave" class="text-5xl font-extrabold text-red-500 drop-shadow-sm">0</div>
                        </div>
                        
                        <div id="leave-names" class="text-xs text-gray-400 mt-3 space-y-1 max-h-[150px] overflow-y-auto px-1">
                            <p class="italic text-center opacity-50">- Tidak ada yang cuti -</p>
                        </div>
                    </div>
                </div>

                <!-- Panel Karyawan -->
                <div id="employee-controls" class="hidden space-y-6">
                    <!-- Form Pengajuan -->
                    <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                        <h3 class="font-bold text-white border-b border-gray-700 pb-3 mb-4 flex items-center text-lg">
                            <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Ajukan Cuti
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-semibold text-gray-400 uppercase">Mulai Tanggal</label>
                                <input id="start-date" type="date" class="w-full mt-1 bg-gray-700 border border-gray-600 text-white p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition [color-scheme:dark]">
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-400 uppercase">Sampai Tanggal</label>
                                <input id="end-date" type="date" class="w-full mt-1 bg-gray-700 border border-gray-600 text-white p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition [color-scheme:dark]">
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-400 uppercase">Alasan</label>
                                <input id="reason" type="text" placeholder="Contoh: Acara Keluarga" class="w-full mt-1 bg-gray-700 border border-gray-600 text-white p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition placeholder-gray-500">
                            </div>
                            <button onclick="submitRequest()" class="w-full bg-green-600 hover:bg-green-500 text-white py-2.5 rounded-lg font-bold shadow-lg shadow-green-600/20 transition mt-2 transform active:scale-95">
                                Kirim Pengajuan
                            </button>
                        </div>
                    </div>

                    <!-- Riwayat Pengajuan (Notifikasi Status) -->
                    <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                        <h3 class="font-bold text-white border-b border-gray-700 pb-3 mb-4 flex items-center text-lg">
                            <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Riwayat Saya
                        </h3>
                        <div id="my-history-list" class="space-y-3 max-h-[300px] overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-transparent">
                            <!-- List akan muncul di sini -->
                            <p class="text-xs text-gray-500 italic text-center py-4">Belum ada riwayat.</p>
                        </div>
                    </div>
                </div>

                <!-- Panel Manager -->
                <div id="manager-controls" class="hidden bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                    <h3 class="font-bold text-white border-b border-gray-700 pb-3 mb-4 flex items-center text-lg">
                        <svg class="w-5 h-5 mr-2 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                        Menunggu Persetujuan
                    </h3>
                    <div id="pending-list" class="space-y-3 max-h-[500px] overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-transparent">
                        <!-- List akan muncul di sini -->
                        <p class="text-xs text-gray-500 italic text-center py-4">Tidak ada pengajuan pending.</p>
                    </div>
                </div>
            </div>

            <!-- AREA KALENDER -->
            <div class="lg:col-span-3 bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg border border-gray-700 min-h-[500px]">
                <div id="calendar" class="text-sm font-medium"></div>
            </div>
        </div>

        <!-- VIEW: REPORT (Manager Only) -->
        <div id="report-content" class="hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                    <h2 class="text-xl font-bold text-white">Laporan Rekapitulasi Cuti (Disetujui)</h2>
                    <button onclick="toggleReportView()" class="text-sm text-gray-400 hover:text-white underline">Kembali ke Dashboard</button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-gray-700 text-xs uppercase text-gray-200">
                            <tr>
                                <th class="px-4 py-3 rounded-tl-lg">Nama Pegawai</th>
                                <th class="px-4 py-3">Divisi</th>
                                <th class="px-4 py-3 text-center">Total Cuti (Hari)</th>
                                <th class="px-4 py-3 rounded-tr-lg text-right">Detail Tanggal</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body" class="divide-y divide-gray-700">
                            <!-- Data injected via JS -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-xs text-gray-500 italic">
                    * Hanya menghitung cuti dengan status 'Approved'.
                </div>
            </div>
        </div>

    </div>

    <script>
        let currentUser = null;
        let calendar = null;
        let allRequestsData = []; 
        let clockInterval = null; // Variabel untuk interval jam
        const SESSION_KEY = 'cuti_app_session'; // Kunci untuk penyimpanan sesi lokal
        const SESSION_TIMEOUT = 12 * 60 * 60 * 1000; // 12 Jam timeout untuk auto-logout

        // --- DATABASE LIBUR INDONESIA (2025-2028) ---
        // Estimasi tanggal merah, cek SKB 3 Menteri untuk kepastian
        const INDONESIAN_HOLIDAYS = {
            // 2025
            "2025-01-01": "Tahun Baru Masehi",
            "2025-01-27": "Isra Mikraj Nabi Muhammad SAW",
            "2025-01-29": "Tahun Baru Imlek 2576 Kongzili",
            "2025-03-29": "Hari Suci Nyepi Tahun Baru Saka 1947",
            "2025-03-31": "Idul Fitri 1446 H",
            "2025-04-01": "Idul Fitri 1446 H",
            "2025-04-18": "Wafat Yesus Kristus",
            "2025-05-01": "Hari Buruh Internasional",
            "2025-05-12": "Hari Raya Waisak 2569 BE",
            "2025-05-29": "Kenaikan Yesus Kristus",
            "2025-06-01": "Hari Lahir Pancasila",
            "2025-06-06": "Idul Adha 1446 H",
            "2025-06-27": "Tahun Baru Islam 1447 H",
            "2025-08-17": "Hari Kemerdekaan RI",
            "2025-09-05": "Maulid Nabi Muhammad SAW",
            "2025-12-25": "Hari Raya Natal",
            
            // 2026
            "2026-01-01": "Tahun Baru Masehi",
            "2026-01-16": "Isra Mikraj Nabi Muhammad SAW",
            "2026-02-17": "Tahun Baru Imlek 2577 Kongzili",
            "2026-03-19": "Hari Suci Nyepi Tahun Baru Saka 1948",
            "2026-03-21": "Idul Fitri 1447 H (Estimasi)",
            "2026-03-22": "Idul Fitri 1447 H (Estimasi)",
            "2026-04-03": "Wafat Yesus Kristus",
            "2026-04-05": "Paskah (Kebangkitan Yesus Kristus)",
            "2026-05-01": "Hari Buruh Internasional",
            "2026-05-14": "Kenaikan Yesus Kristus",
            "2026-05-27": "Idul Adha 1447 H (Estimasi)",
            "2026-05-31": "Hari Raya Waisak 2570 BE",
            "2026-06-01": "Hari Lahir Pancasila",
            "2026-06-16": "Tahun Baru Islam 1448 H",
            "2026-08-17": "Hari Kemerdekaan RI",
            "2026-08-25": "Maulid Nabi Muhammad SAW",
            "2026-12-25": "Hari Raya Natal",

            // 2027 (Estimasi)
            "2027-01-01": "Tahun Baru Masehi",
            "2027-01-05": "Isra Mikraj Nabi Muhammad SAW (Estimasi)",
            "2027-02-06": "Tahun Baru Imlek 2578 Kongzili",
            "2027-03-09": "Hari Suci Nyepi Tahun Baru Saka 1949",
            "2027-03-10": "Idul Fitri 1448 H (Estimasi)",
            "2027-03-11": "Idul Fitri 1448 H (Estimasi)",
            "2027-03-26": "Wafat Yesus Kristus",
            "2027-03-28": "Paskah",
            "2027-05-01": "Hari Buruh Internasional",
            "2027-05-06": "Kenaikan Yesus Kristus",
            "2027-05-17": "Idul Adha 1448 H (Estimasi)",
            "2027-05-20": "Hari Raya Waisak 2571 BE",
            "2027-06-01": "Hari Lahir Pancasila",
            "2027-06-06": "Tahun Baru Islam 1449 H",
            "2027-08-15": "Maulid Nabi Muhammad SAW (Estimasi)",
            "2027-08-17": "Hari Kemerdekaan RI",
            "2027-12-25": "Hari Raya Natal",
            "2027-12-26": "Isra Mikraj Nabi Muhammad SAW (Estimasi)",

            // 2028 (Estimasi)
            "2028-01-01": "Tahun Baru Masehi",
            "2028-01-26": "Tahun Baru Imlek 2579 Kongzili",
            "2028-02-26": "Idul Fitri 1449 H (Estimasi)",
            "2028-02-27": "Idul Fitri 1449 H (Estimasi)",
            "2028-03-26": "Hari Suci Nyepi Tahun Baru Saka 1950",
            "2028-04-14": "Wafat Yesus Kristus",
            "2028-04-16": "Paskah",
            "2028-05-01": "Hari Buruh Internasional",
            "2028-05-05": "Idul Adha 1449 H (Estimasi)",
            "2028-05-09": "Hari Raya Waisak 2572 BE",
            "2028-05-25": "Kenaikan Yesus Kristus & Tahun Baru Islam 1450 H",
            "2028-06-01": "Hari Lahir Pancasila",
            "2028-08-03": "Maulid Nabi Muhammad SAW (Estimasi)",
            "2028-08-17": "Hari Kemerdekaan RI",
            "2028-12-14": "Isra Mikraj Nabi Muhammad SAW (Estimasi)",
            "2028-12-25": "Hari Raya Natal"
        };

        // --- CEK SESI SAAT HALAMAN DIMUAT ---
        document.addEventListener("DOMContentLoaded", () => {
            checkSession();
        });

        function checkSession() {
            const savedSession = localStorage.getItem(SESSION_KEY);
            if (savedSession) {
                try {
                    // Security Tweak: Decode Base64 (Obfuscation)
                    // Mencegah data dibaca langsung sebagai plain text
                    const decoded = atob(savedSession);
                    const sessionData = JSON.parse(decoded);

                    // Security Tweak: Cek apakah sesi sudah kadaluarsa (Expired)
                    if (Date.now() > sessionData.expiry) {
                        console.warn("Sesi telah berakhir.");
                        localStorage.removeItem(SESSION_KEY);
                        return; // Jangan login, biarkan di halaman login
                    }

                    // Jika valid dan belum expired, langsung masuk
                    initializeDashboard(sessionData.user);
                } catch (e) {
                    console.error("Sesi tidak valid", e);
                    localStorage.removeItem(SESSION_KEY);
                }
            }
        }

        // --- FUNGSI UTILITY ---
        function checkEnter(event) {
            if (event.key === 'Enter') {
                handleLogin();
            }
        }

        function calculateDays(startStr, endStr) {
            const start = new Date(startStr);
            const end = new Date(endStr);
            // Hitung selisih waktu dalam milidetik
            const diffTime = Math.abs(end - start);
            // Konversi ke hari ( +1 karena inklusif)
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
            return diffDays;
        }

        function toggleReportView() {
            const dash = document.getElementById('dashboard-content');
            const report = document.getElementById('report-content');
            const btn = document.getElementById('btn-report');
            const ann = document.getElementById('announcement-section');
            
            if (dash.classList.contains('hidden')) {
                // Show Dashboard
                dash.classList.remove('hidden');
                ann.classList.remove('hidden'); // Show announcement
                report.classList.add('hidden');
                btn.classList.remove('bg-gray-600');
                btn.classList.add('bg-blue-600');
                btn.innerHTML = `<svg class="w-4 h-4 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span class="hidden md:inline">Laporan</span>`;
            } else {
                // Show Report
                dash.classList.add('hidden');
                ann.classList.add('hidden'); // Hide announcement to focus on report
                report.classList.remove('hidden');
                renderReportTable(allRequestsData);
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-600');
                btn.innerHTML = `â† Kembali`;
            }
        }

        function scrollToPending() {
            // Scroll ke bagian pending list di sidebar (untuk mobile/desktop)
            const pendingList = document.getElementById('manager-controls');
            if(pendingList && !pendingList.classList.contains('hidden')) {
                pendingList.scrollIntoView({ behavior: 'smooth' });
                pendingList.classList.add('ring-2', 'ring-yellow-500'); // Highlight effect
                setTimeout(() => pendingList.classList.remove('ring-2', 'ring-yellow-500'), 2000);
            }
        }

        // --- FUNGSI JAM (UTC+7 / WIB) ---
        function startClock() {
            if (clockInterval) clearInterval(clockInterval);
            
            const update = () => {
                const el = document.getElementById('clock-display');
                if (!el) return;
                
                const now = new Date();
                // Opsi untuk Waktu Indonesia Barat (Asia/Jakarta)
                const options = { 
                    timeZone: 'Asia/Jakarta', 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit', 
                    hour12: false 
                };
                
                // Format: Jumat, 2 Januari 2026 16.27.00
                let timeString = new Intl.DateTimeFormat('id-ID', options).format(now);
                
                // Mengganti titik dengan titik dua agar terlihat seperti jam digital biasa jika browser menggunakan format 16.27.00
                timeString = timeString.replace(/\./g, ':');
                
                el.innerText = timeString + " WIB";
            };
            
            update(); // Panggil sekali langsung
            clockInterval = setInterval(update, 1000); // Update tiap detik
        }

        // --- FUNGSI API ---
        async function callAPI(payload) {
            if(!API_URL.includes("script.google.com")) {
                alert("ERROR: Anda belum memasukkan URL Google Script di kode HTML baris 15!");
                return;
            }

            document.getElementById('loading').classList.remove('hidden'); 
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                document.getElementById('loading').classList.add('hidden'); 
                return result;
            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                alert("Gagal terhubung ke server. Cek koneksi internet.");
                console.error(error);
                return null;
            }
        }

        // --- LOGIKA APLIKASI ---

        async function handleLogin() {
            const u = document.getElementById('user-input').value.trim();
            const p = document.getElementById('pass-input').value.trim();
            
            if(!u || !p) return alert("Username dan Password wajib diisi");

            const res = await callAPI({ action: 'login', username: u, password: p });

            if (res && res.success) {
                // Security Tweak: Simpan Sesi dengan Encodng Base64 & Waktu Expired
                const sessionData = {
                    user: res,
                    expiry: Date.now() + SESSION_TIMEOUT
                };
                // Encode object ke string Base64 agar tidak terbaca plain text
                const encoded = btoa(JSON.stringify(sessionData));
                
                localStorage.setItem(SESSION_KEY, encoded);

                // Security Tweak: Langsung bersihkan field password di UI
                document.getElementById('pass-input').value = "";
                
                initializeDashboard(res);
            } else {
                alert("Login Gagal: Username atau Password salah.");
                document.getElementById('pass-input').value = ""; // Bersihkan password jika gagal
            }
        }

        // Fungsi inisialisasi dashboard (dipanggil saat login sukses atau cek sesi)
        function initializeDashboard(user) {
            currentUser = user;
            
            // Transisi Tampilan
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            
            // Tampilkan Nama Asli (Real Name) jika ada, jika tidak pakai Username
            // Backend harus mengirim field 'realName'
            const displayName = user.realName || user.username;
            const displayRole = user.role + (user.division ? ` - ${user.division}` : '');
            document.getElementById('welcome-msg').innerText = `Halo, ${displayName} (${displayRole})`;

            // Jalankan Jam
            startClock();

            // Reset Tampilan Menu
            document.getElementById('manager-controls').classList.add('hidden');
            document.getElementById('employee-controls').classList.add('hidden');
            document.getElementById('btn-report').classList.add('hidden'); 
            document.getElementById('btn-edit-announcement').classList.add('hidden');
            document.getElementById('manager-notif').classList.add('hidden');

            if (user.role === 'Manager') {
                document.getElementById('manager-controls').classList.remove('hidden');
                document.getElementById('btn-report').classList.remove('hidden'); 
                document.getElementById('btn-edit-announcement').classList.remove('hidden'); // Show Edit Button
                document.getElementById('manager-notif').classList.remove('hidden'); // Show Notification Bell
            } else {
                document.getElementById('employee-controls').classList.remove('hidden');
            }
            
            // Load all data
            loadData();
            loadAnnouncement();
        }

        function logout() {
            if(confirm("Keluar dari aplikasi?")) {
                // 1. Hapus Sesi
                localStorage.removeItem(SESSION_KEY);
                currentUser = null;
                if(clockInterval) clearInterval(clockInterval);

                // 2. Reset Tampilan ke Login
                document.getElementById('app-view').classList.add('hidden');
                document.getElementById('login-view').classList.remove('hidden');
                
                // 3. Bersihkan Form Input
                document.getElementById('user-input').value = "";
                document.getElementById('pass-input').value = "";
                
                // 4. Reset konten dinamis
                document.getElementById('welcome-msg').innerText = "";
                document.getElementById('manager-controls').classList.add('hidden');
                document.getElementById('employee-controls').classList.add('hidden');
                
                // Reset report view if active
                const dash = document.getElementById('dashboard-content');
                const report = document.getElementById('report-content');
                dash.classList.remove('hidden');
                report.classList.add('hidden');
            }
        }

        // --- LOGIKA PENGUMUMAN & NOTIFIKASI ---

        async function loadAnnouncement() {
            // Ambil Announcement dari Server
            const res = await callAPI({ action: 'getAnnouncement' });
            const annSection = document.getElementById('announcement-section');
            const annText = document.getElementById('announcement-text');
            
            if (res && res.success && res.text) {
                annText.innerText = res.text;
                annSection.classList.remove('hidden');
            } else {
                // Jika kosong, manager tetap melihat (untuk edit), employee hide
                if(currentUser.role === 'Manager') {
                    annText.innerText = "Belum ada pengumuman aktif. Klik tombol pensil untuk mengedit.";
                    annSection.classList.remove('hidden');
                } else {
                    annSection.classList.add('hidden');
                }
            }
        }

        function openAnnouncementModal() {
            const currentText = document.getElementById('announcement-text').innerText;
            document.getElementById('announcement-input').value = currentText === "Belum ada pengumuman aktif. Klik tombol pensil untuk mengedit." ? "" : currentText;
            document.getElementById('announcement-modal').classList.remove('hidden');
        }

        async function saveAnnouncement() {
            const newText = document.getElementById('announcement-input').value;
            const res = await callAPI({ 
                action: 'updateAnnouncement', 
                text: newText,
                username: currentUser.username // Security check di backend
            });
            
            if(res && res.success) {
                document.getElementById('announcement-modal').classList.add('hidden');
                loadAnnouncement(); // Reload UI
            } else {
                alert("Gagal menyimpan pengumuman.");
            }
        }

        function updateNotificationCount(data) {
            // Hanya jalankan jika user adalah Manager
            if (currentUser.role !== 'Manager') return;

            const pendingCount = data.filter(r => r.status === 'Pending').length;
            const badge = document.getElementById('notif-badge');
            
            if (pendingCount > 0) {
                badge.innerText = pendingCount;
                badge.classList.remove('hidden');
                
                // Optional: Update title browser tab
                document.title = `(${pendingCount}) Sistem Cuti Pegawai`;
            } else {
                badge.classList.add('hidden');
                document.title = `Sistem Cuti Pegawai`;
            }
        }

        // --- FUNGSI REQUEST, DATA, CALENDAR ---

        async function submitRequest() {
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            const reason = document.getElementById('reason').value;

            if(!start || !end) return alert("Harap isi tanggal mulai dan selesai.");

            const res = await callAPI({
                action: 'addRequest',
                username: currentUser.username,
                division: currentUser.division, 
                start: start, end: end, reason: reason
            });

            if(res && res.success) {
                alert("Pengajuan Cuti Berhasil Dikirim!");
                document.getElementById('start-date').value = "";
                document.getElementById('end-date').value = "";
                document.getElementById('reason').value = "";
                loadData();
            }
        }

        async function updateRequest(id, status) {
            const text = status === 'Approved' ? 'TERIMA' : 'TOLAK';
            let adminReason = ""; // Variabel untuk menyimpan alasan penolakan
            
            if (status === 'Approved') {
                const req = allRequestsData.find(r => r.id == id);
                if (req) {
                    const limitCheck = checkLeaveLimit(req.start.split('T')[0], req.end.split('T')[0]);
                    
                    if (limitCheck.overflow) {
                        const confirmOverflow = confirm(
                            `PERINGATAN: Tanggal ${limitCheck.date} sudah ada ${limitCheck.count} pegawai yang cuti.\n\n` +
                            `Apakah Anda yakin tetap ingin menyetujui (Approve) permintaan ini?`
                        );
                        if (!confirmOverflow) return; 
                    }
                }
            } else {
                // JIKA REJECT: Minta alasan penolakan
                adminReason = prompt("Masukkan alasan penolakan (Opsional):");
                if (adminReason === null) return; // Batalkan jika user klik Cancel
            }
            
            // Kirim status beserta alasan (adminReason) ke server
            await callAPI({ action: 'updateStatus', id: id, status: status, adminReason: adminReason });
            loadData();
        }

        async function loadData() {
            const res = await callAPI({ action: 'getRequests' });
            if (!res || !res.success) return;

            allRequestsData = res.data; 
            renderCalendar(res.data);
            renderManagerList(res.data);
            renderEmployeeHistory(res.data);
            renderTodayStatus(res.data); 
            updateNotificationCount(res.data); // UPDATE NOTIFIKASI
            
            // If report view is active, re-render it too
            if (!document.getElementById('report-content').classList.contains('hidden')) {
                renderReportTable(res.data);
            }
        }

        // --- FITUR STATUS HARIAN ---
        function renderTodayStatus(data) {
            const today = new Date().toISOString().split('T')[0];
            
            // Filter orang yang sedang cuti hari ini (Approved)
            const onLeaveToday = data.filter(r => {
                if (r.status !== 'Approved') return false;
                const dates = getDatesInRange(r.start.split('T')[0], r.end.split('T')[0]);
                return dates.includes(today);
            });

            const count = onLeaveToday.length;
            document.getElementById('count-leave').innerText = count;

            const nameListEl = document.getElementById('leave-names');
            if (count > 0) {
                // UPDATE: Menggunakan Real Name jika ada
                const names = onLeaveToday.map(r => {
                    const displayName = r.realName || r.username;
                    return `<div class="mb-1">â€¢ ${displayName} ${r.division ? '('+r.division+')' : ''}</div>`;
                }).join('');
                nameListEl.innerHTML = names;
                nameListEl.classList.remove('italic');
            } else {
                nameListEl.innerHTML = "- Tidak ada yang cuti -";
                nameListEl.classList.add('italic');
            }
        }

        // --- FITUR REPORT TABLE ---
        function renderReportTable(data) {
            const tbody = document.getElementById('report-table-body');
            tbody.innerHTML = "";

            // 1. Group data by User
            const userStats = {};

            data.forEach(r => {
                if (r.status === 'Approved') {
                    // Key can be username, but we want to display Real Name
                    const key = r.username;
                    if (!userStats[key]) {
                        userStats[key] = {
                            realName: r.realName || r.username,
                            division: r.division || '-',
                            totalDays: 0,
                            history: []
                        };
                    }
                    
                    const days = calculateDays(r.start.split('T')[0], r.end.split('T')[0]);
                    userStats[key].totalDays += days;
                    userStats[key].history.push(`${r.start.substring(0,10)} s/d ${r.end.substring(0,10)} (${days} hari)`);
                }
            });

            // 2. Render Row
            Object.values(userStats).forEach(stat => {
                const historyHtml = stat.history.map(h => `<div class="text-xs text-gray-500">${h}</div>`).join('');
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-700/50 transition">
                        <td class="px-4 py-3 font-medium text-white">${stat.realName}</td>
                        <td class="px-4 py-3">${stat.division}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="inline-block bg-blue-500/20 text-blue-300 px-2 py-1 rounded font-bold">${stat.totalDays}</span>
                        </td>
                        <td class="px-4 py-3 text-right">
                            ${historyHtml}
                        </td>
                    </tr>
                `;
            });

            if (Object.keys(userStats).length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 italic">Belum ada cuti yang disetujui.</td></tr>`;
            }
        }

        function getDatesInRange(startDateStr, endDateStr) {
            const dates = [];
            let currentDate = new Date(startDateStr);
            const stopDate = new Date(endDateStr);
            while (currentDate <= stopDate) {
                dates.push(new Date(currentDate).toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        function checkLeaveLimit(startDate, endDate) {
            const dateRange = getDatesInRange(startDate, endDate);
            const approvedRequests = allRequestsData.filter(r => r.status === 'Approved');

            for (let date of dateRange) {
                let count = 0;
                for (let req of approvedRequests) {
                    const reqRange = getDatesInRange(req.start.split('T')[0], req.end.split('T')[0]);
                    if (reqRange.includes(date)) count++;
                }
                if (count >= 2) return { overflow: true, date: date, count: count };
            }
            return { overflow: false };
        }

        function renderCalendar(data) {
            const calendarEl = document.getElementById('calendar');
            const isMobile = window.innerWidth < 768;
            
            if(!calendar) {
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    height: 'auto', 
                    headerToolbar: {
                        left: isMobile ? 'prev,next' : 'prev,next today',
                        center: 'title',
                        right: isMobile ? '' : 'dayGridMonth,listWeek'
                    },
                    buttonText: { today: 'Hari Ini', month: 'Bulan', list: 'List' },
                    footerToolbar: isMobile ? { center: 'today' } : false,
                    
                    // --- KONFIGURASI HARI LIBUR ---
                    dayCellClassNames: (arg) => {
                        const dateStr = arg.date.toLocaleDateString('en-CA');
                        if (INDONESIAN_HOLIDAYS[dateStr]) {
                            return ['fc-day-holiday'];
                        }
                        return [];
                    },
                    dayCellDidMount: (arg) => {
                        const dateStr = arg.date.toLocaleDateString('en-CA');
                        if (INDONESIAN_HOLIDAYS[dateStr]) {
                            arg.el.setAttribute('title', INDONESIAN_HOLIDAYS[dateStr]);
                        }
                    },
                    
                    eventDidMount: function(info) {
                        if (info.event.extendedProps.description) {
                            info.el.setAttribute('title', "Alasan: " + info.event.extendedProps.description);
                        }
                    }
                });
                calendar.render();
            }
            
            const events = data
                .filter(r => r.status !== 'Rejected') 
                .map(r => {
                    let color = '#f59e0b'; 
                    let desc = ""; 
                    
                    if(r.status === 'Approved') {
                        color = '#16a34a'; 
                        desc = r.reason; 
                    }

                    const displayName = r.realName || r.username;

                    return {
                        title: `${displayName} (${r.status})`,
                        start: r.start.split('T')[0],
                        end: r.end.split('T')[0],
                        color: color,
                        allDay: true,
                        extendedProps: {
                            description: desc
                        }
                    };
                });
            
            calendar.removeAllEvents();
            calendar.addEventSource(events);
        }

        function renderManagerList(data) {
            if (currentUser.role !== 'Manager') return;
            const list = document.getElementById('pending-list');
            list.innerHTML = "";
            const pendingItems = data.filter(r => r.status === 'Pending');

            if(pendingItems.length === 0) {
                 list.innerHTML = '<p class="text-xs text-gray-500 italic text-center py-4">Tidak ada pengajuan pending.</p>';
                 return;
            }
            
            pendingItems.forEach(r => {
                const divisionBadge = r.division 
                    ? `<span class="ml-2 text-[10px] bg-blue-500/20 text-blue-300 px-1.5 py-0.5 rounded border border-blue-500/30 uppercase tracking-wide">${r.division}</span>` 
                    : '';

                const displayName = r.realName || r.username;

                list.innerHTML += `
                    <div class="bg-gray-700/50 p-4 border border-gray-600 rounded-lg shadow-sm hover:bg-gray-700 transition">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center">
                                <span class="font-bold text-white text-lg">${displayName}</span>
                                ${divisionBadge}
                            </div>
                            <span class="text-xs bg-yellow-500/20 text-yellow-300 border border-yellow-500/30 px-2 py-0.5 rounded-full font-medium">Pending</span>
                        </div>
                        <p class="text-xs text-gray-400 mb-1 flex items-center">
                            ðŸ“… ${r.start.substring(0,10)} <span class="mx-1">âžž</span> ${r.end.substring(0,10)}
                        </p>
                        <div class="text-sm text-gray-300 mb-4 bg-gray-800 p-2.5 rounded border border-gray-600 italic">
                            "${r.reason}"
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="updateRequest(${r.id}, 'Approved')" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-green-900/20 flex items-center justify-center">
                                âœ“ Terima
                            </button>
                            <button onclick="updateRequest(${r.id}, 'Rejected')" class="bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-red-900/20 flex items-center justify-center">
                                âœ• Tolak
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        function renderEmployeeHistory(data) {
            if (currentUser.role === 'Manager') return;
            const list = document.getElementById('my-history-list');
            list.innerHTML = "";
            const myItems = data.filter(r => r.username.toLowerCase() === currentUser.username.toLowerCase());

            if(myItems.length === 0) {
                 list.innerHTML = '<p class="text-xs text-gray-500 italic text-center py-4">Belum ada riwayat pengajuan.</p>';
                 return;
            }

            myItems.forEach(r => {
                let badgeClass = "bg-yellow-500/20 text-yellow-300 border-yellow-500/30";
                if(r.status === 'Approved') badgeClass = "bg-green-500/20 text-green-300 border-green-500/30";
                
                let rejectNote = "";
                if(r.status === 'Rejected') {
                    badgeClass = "bg-red-500/20 text-red-300 border-red-500/30";
                    const reasonText = r.adminReason ? r.adminReason : "-";
                    rejectNote = `
                        <div class="mt-2 p-2 bg-red-900/30 border border-red-500/20 rounded text-xs text-red-200">
                            <span class="font-bold text-red-400">Alasan Ditolak:</span> ${reasonText}
                        </div>
                    `;
                }

                list.innerHTML += `
                    <div class="bg-gray-700/30 p-3 border border-gray-600 rounded-lg">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-400">${r.start.substring(0,10)}</span>
                            <span class="text-[10px] px-2 py-0.5 rounded-full border ${badgeClass} font-medium uppercase">${r.status}</span>
                        </div>
                        <p class="text-sm font-semibold text-gray-200">"${r.reason}"</p>
                        ${rejectNote}
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
